–ó–∞–¥–∞—á–∞: –ú–æ–¥—É–ª—å IntentClassifier (v3, Stateless-–≤–µ—Ä—Å–∏—è)

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—É—é, —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—É—é —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é –¥–ª—è –º–æ–¥—É–ª—è, –æ—Ç–≤–µ—á–∞—é—â–µ–≥–æ –∑–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –Ω–∞–º–µ—Ä–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –í–µ—Ä—Å–∏—è 3 —è–≤–ª—è–µ—Ç—Å—è –∫–ª—é—á–µ–≤—ã–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º, –¥–µ–ª–∞—é—â–∏–º –º–æ–¥—É–ª—å –ø–æ–ª–Ω–æ—Å—Ç—å—é stateless (–Ω–µ —Ö—Ä–∞–Ω—è—â–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ), —á—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –µ–≥–æ –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å –≤ –≤—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–π –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Å—Ä–µ–¥–µ.

1. –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏ —Ü–µ–ª—å –º–æ–¥—É–ª—è (CONTEXT)

IntentClassifier —è–≤–ª—è–µ—Ç—Å—è ‚Äú—Ä–µ—Ñ–ª–µ–∫—Ç–æ—Ä–Ω–æ–π –¥—É–≥–æ–π‚Äù —Å–∏—Å—Ç–µ–º—ã. –ï–≥–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞ ‚Äî —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é (< 100–º—Å) –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å—é –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –∫–∞–∫–æ–º—É –∏–∑ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –Ω–∞–º–µ—Ä–µ–Ω–∏–π (intent) —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–µ—á—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –û–Ω –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç –≤—Å—é —Å–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã —Å —ç–º–±–µ–¥–¥–∏–Ω–≥-–º–æ–¥–µ–ª—è–º–∏ –∏ –∞–ª–≥–æ—Ä–∏—Ç–º–∞–º–∏ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞.

1.1. –†–æ–ª—å –≤ —Å–∏—Å—Ç–µ–º–µ:

–ú–æ–¥—É–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π, —á–∏—Å—Ç—ã–π (pure) —Å–µ—Ä–≤–∏—Å –¥–ª—è Orchestrator. –û–Ω –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –¥–≤–∞ –∫–ª—é—á–µ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–∞:
	‚Ä¢	‚Äú–ù–∞—Å–∫–æ–ª—å–∫–æ —Ä–µ—á—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–¥–Ω–æ–º—É –∏–∑ –û–ñ–ò–î–ê–ï–ú–´–• –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—é –∏–Ω—Ç–µ–Ω—Ç–æ–≤, —É—á–∏—Ç—ã–≤–∞—è –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç?‚Äù (–û—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã).
	‚Ä¢	‚Äú–ù–∞ —á—Ç–æ –≤ –Ω–∞—à–µ–π –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –ø–æ—Ö–æ–∂ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å?‚Äù (–†–µ–∂–∏–º –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ ‚Äú–Ω–µ –ø–æ —Ç–µ–º–µ‚Äù).

1.2. –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏ (Consumers):
	‚Ä¢	Orchestrator: –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å.
	‚Ä¢	–û—Ñ—Ñ–ª–∞–π–Ω-—Å–∫—Ä–∏–ø—Ç—ã: –°–∫—Ä–∏–ø—Ç prepare_embeddings.py –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–æ—Ç –º–æ–¥—É–ª—å –¥–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤—Å–µ—Ö —Ñ—Ä–∞–∑ –∏–∑ dialogue_map.json.

1.3. –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª (Lifecycle):

–î–æ–ª–≥–æ–∂–∏–≤—É—â–∏–π Singleton. –≠–∫–∑–µ–º–ø–ª—è—Ä —Å–æ–∑–¥–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –í–∞–∂–Ω–æ: –ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —Ç–æ, —á—Ç–æ —ç—Ç–æ Singleton, –æ–Ω —è–≤–ª—è–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é stateless –∏ –Ω–µ —Ö—Ä–∞–Ω–∏—Ç –Ω–∏–∫–∞–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∑–≤–æ–Ω–∫–∞—Ö.

1.5. –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ —à–∞–≥–æ–≤:
–§–∞–π–ª –±—É–¥–µ—Ç —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ –¥–≤—É—Ö –∫–æ—Ä–Ω–µ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤: `intents` –∏ `dialogue_flow`.
**–ü—Ä–∏–º–µ—Ä `intents`:**
```json
{
  "intents": {
    "confirm_yes": {
      "description": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—Ä–∞–∂–∞–µ—Ç —Å–æ–≥–ª–∞—Å–∏–µ",
      "phrases": ["–î–∞", "–í–µ—Ä–Ω–æ", "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é", "–ê–≥–∞", "–í—Å–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ"]
    },
    "confirm_no": {
      "description": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—Ä–∞–∂–∞–µ—Ç –Ω–µ—Å–æ–≥–ª–∞—Å–∏–µ",
      "phrases": ["–ù–µ—Ç", "–ù–µ–≤–µ—Ä–Ω–æ", "–û—Ç–º–µ–Ω–∞", "–ù–µ–∞"]
    },
    "provide_number": {
      "description": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∑—ã–≤–∞–µ—Ç –∫–∞–∫–æ–µ-–ª–∏–±–æ —á–∏—Å–ª–æ",
      "phrases": [
        "–æ—Ç–≤–µ—Ç {number}", "–¥–∞–≤–∞–π—Ç–µ {number}", "{number}", "–ø—É—Å—Ç—å –±—É–¥–µ—Ç {number}"
      ],
      "entity": {
        "type": "number" 
      }
    }
  }
}
```
–ü—Ä–∏–º–µ—Ä dialogue flow:
```json
{
  "dialogue_flow": {
	  "ask_engine_power": {
		  "description": "–°–∏—Å—Ç–µ–º–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –º–æ—â–Ω–æ—Å—Ç—å –¥–≤–∏–≥–∞—Ç–µ–ª—è",
		  "system_response": {
			  "playlist": [
				  {
					  "type": "cache",
					  "key": "static:final_price_intro"
				  },
				  {
					  "type": "filler",
					  "key": "filler:hmm"
				  },
				  {
					  "type": "tts",
					  "text_template": "{{ session.variables.final_price }}"
				  },
				  {
					  "type": "cache",
					  "key": "static:currency_rubles"
				  }
			  ]
		  },
		  "transitions": {
			  "provide_number": {
				  "next_state": "ask_about_drivers",
				  "execute_code": "session.variables['engine_power'] = entities['value']\nif entities['value'] > 200:\n    session.variables['base_tariff'] = 15000\nelse:\n    session.variables['base_tariff'] = 12000"
			  }
		  },
		  "long_operation": true
	  },
    "state_goodbye_and_hangup": {
      "description": "–§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ. –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º –ø—Ä–æ—â–∞–Ω–∏–µ –∏ –∑–∞–≤–µ—Ä—à–∞–µ–º –∑–≤–æ–Ω–æ–∫.",
      
      "action": "END_CALL",

      "system_response": {
        "playlist": [
          {
            "type": "cache",
            "key": "static:polite_goodbye" 
          }
        ]
      },
      "transitions": {} 
    }
}
}
```


1.6. models.py

```python
@dataclass(slots=True)
class FaqResult:
    question_id: str
    answer_text: str
    score: float
```

2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

–ú–æ–¥—É–ª—å –±—É–¥–µ—Ç —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —á–µ—Ç–∫–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã—Ö –ø–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∫–ª–∞—Å—Å–æ–≤, –Ω–∞—Ö–æ–¥—è—â–∏—Ö—Å—è –≤ –ø–∞–∫–µ—Ç–µ intent_classifier/.

2.1. intent_classifier/model_wrapper.py -> –ö–ª–∞—Å—Å OnnxModelWrapper

–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –ü–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É —Å optimum.onnxruntime. –°–∫—Ä—ã–≤–∞–µ—Ç –æ—Ç –æ—Å—Ç–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –¥–µ—Ç–∞–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏ –∏ —Ç–æ–∫–µ–Ω–∏–∑–∞—Ü–∏–∏.

–ü—É–±–ª–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã:
	‚Ä¢	__init__(self, model_path: str, device: str): –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä. –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ —Å –ª–æ–∫–∞–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –º–æ–¥–µ–ª—å—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, ./models/MiniLM-L12-v2) –∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä (CPUExecutionProvider –∏–ª–∏ CUDAExecutionProvider). –ó–∞–≥—Ä—É–∂–∞–µ—Ç –º–æ–¥–µ–ª—å –∏ —Ç–æ–∫–µ–Ω–∏–∑–∞—Ç–æ—Ä.
	‚Ä¢	async embed(self, texts: List[str]) -> np.ndarray: –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥. –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ç–µ–∫—Å—Ç–æ–≤ –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç NumPy-–º–∞—Å—Å–∏–≤ —Å –∏—Ö —ç–º–±–µ–¥–¥–∏–Ω–≥–∞–º–∏. –í–Ω—É—Ç—Ä–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç asyncio.to_thread –¥–ª—è –≤—ã–∑–æ–≤–∞ –±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –º–æ–¥–µ–ª–∏.

2.2. intent_classifier/repository.py -> –ö–ª–∞—Å—Å IntentRepository

–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –°–ª–æ–π –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º. –•—Ä–∞–Ω–∏—Ç –≤—Å–µ –∏–Ω—Ç–µ–Ω—Ç—ã, –∏—Ö —Ñ—Ä–∞–∑—ã –∏ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–∏. –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –±—ç–∫–∞–ø –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ.

–ü—É–±–ª–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã:
	‚Ä¢	load_from_backup(self, filepath: str): –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤ –ø–∞–º—è—Ç—å –≥–æ—Ç–æ–≤—ã–π –±—ç–∫–∞–ø (–Ω–∞–ø—Ä–∏–º–µ—Ä, intents.pkl), —Å–æ–¥–µ—Ä–∂–∞—â–∏–π intent_id –∏ –∏—Ö –≤–µ–∫—Ç–æ—Ä—ã.
	‚Ä¢	prepare_and_save_backup(self, dialogue_map: dict, model_wrapper: OnnxModelWrapper, filepath: str): –ú–µ—Ç–æ–¥ –¥–ª—è –æ—Ñ—Ñ–ª–∞–π–Ω-—Å–∫—Ä–∏–ø—Ç–∞. –ü—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ dialogue_map.json, –≤–µ–∫—Ç–æ—Ä–∏–∑—É–µ—Ç –≤—Å–µ —Ñ—Ä–∞–∑—ã —á–µ—Ä–µ–∑ model_wrapper –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–∞–π–ª.
	‚Ä¢	get_intent_vectors(self, intent_ids: List[str]) -> Dict[str, np.ndarray]: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–µ –≤–µ–∫—Ç–æ—Ä—ã –¥–ª—è –∑–∞–ø—Ä–æ—à–µ–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –∏–Ω—Ç–µ–Ω—Ç–æ–≤.
	‚Ä¢	get_all_faq_vectors(self) -> Dict[str, np.ndarray]: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–µ–∫—Ç–æ—Ä—ã –¥–ª—è –≤—Å–µ—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π.
	‚Ä¢	get_intent_metadata(self, intent_id: str) -> Optional[dict]: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–Ω—Ç–µ–Ω—Ç–∞, –≤–∫–ª—é—á–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–º, –∫–∞–∫—É—é —Å—É—â–Ω–æ—Å—Ç—å –Ω—É–∂–Ω–æ –∏–∑–≤–ª–µ–∫–∞—Ç—å.

2.3. intent_classifier/entity_extractors.py -> –ù–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã-–ø–∞—Ä—Å–µ—Ä—ã

–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –ù–æ–≤—ã–π —Ñ–∞–π–ª, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –Ω–∞–±–æ—Ä –ø—Ä–æ—Å—Ç—ã—Ö –∫–ª–∞—Å—Å–æ–≤ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö.

–ü—Ä–∏–º–µ—Ä—ã –∫–ª–∞—Å—Å–æ–≤:

class SimpleNumericExtractor:
    def extract(self, text: str) -> Optional[int]: ...
    
class BooleanExtractor:
    def extract(self, text: str) -> Optional[bool]: ...

2.4. intent_classifier/classifier.py -> –ö–ª–∞—Å—Å IntentClassifier

–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å –º–æ–¥—É–ª—è, —Ä–µ–∞–ª–∏–∑—É—é—â–∏–π –≤—Å—é –ª–æ–≥–∏–∫—É. –Ø–≤–ª—è–µ—Ç—Å—è ‚Äú—Ñ–∞—Å–∞–¥–æ–º‚Äù –¥–ª—è Orchestrator.

–ü—É–±–ª–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã:
	‚Ä¢	__init__(self, model: OnnxModelWrapper, repo: IntentRepository, config: dict, extractors: dict): –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä. –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏. –ë–æ–ª—å—à–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–ª–æ–≤–∞—Ä–∏ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–≤–æ–Ω–∫–æ–≤.
	‚Ä¢	async classify_intent(self, text: str, expected_intents: List[str], previous_leader: Optional[str] = None) -> Optional[IntentResult]: (–ò–ó–ú–ï–ù–ï–ù–ê –°–ò–ì–ù–ê–¢–£–†–ê) –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥. –¢–µ–ø–µ—Ä—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç previous_leader –∫–∞–∫ –∞—Ä–≥—É–º–µ–Ω—Ç. 
	‚Ä¢	async find_faq_answer(self, text: str) -> Optional[FaqResult]: –†–µ–∞–ª–∏–∑—É–µ—Ç —Ä–µ–∂–∏–º ‚Äú–ü–æ–∏—Å–∫–æ–≤–∏–∫–∞‚Äù.

3. –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã classify_intent (Stateless-–≤–µ—Ä—Å–∏—è)

–≠—Ç–æ –∫–ª—é—á–µ–≤–æ–π –º–µ—Ç–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è Orchestrator-–æ–º –Ω–∞ –∫–∞–∂–¥—ã–π partial –∏ final —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç STT.

–í—Ö–æ–¥:
	‚Ä¢	text: –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–∞—è —Ä–µ—á—å.
	‚Ä¢	expected_intents: –°–ø–∏—Å–æ–∫ ID –∏–Ω—Ç–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –∂–¥–µ–º –Ω–∞ —ç—Ç–æ–º —à–∞–≥–µ.
	‚Ä¢	previous_leader: Optional[str]: (–ù–û–í–´–ô –ê–†–ì–£–ú–ï–ù–¢) ID –∏–Ω—Ç–µ–Ω—Ç–∞-–ª–∏–¥–µ—Ä–∞ —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ partial —à–∞–≥–∞. Orchestrator –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –µ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ SessionState –∏ –ø–µ—Ä–µ–¥–∞—á—É —Å—é–¥–∞.

–í–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:

–í—ã–∑—ã–≤–∞–µ—Ç await self.model.embed([text]) –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤–µ–∫—Ç–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Ñ—Ä–∞–∑—ã.

–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤:

–í—ã–∑—ã–≤–∞–µ—Ç self.repo.get_intent_vectors(expected_intents) –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤–µ–∫—Ç–æ—Ä–æ–≤-–∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤.

–†–∞—Å—á–µ—Ç —Å—Ö–æ–¥—Å—Ç–≤–∞:

–ë—ã—Å—Ç—Ä–æ –≤—ã—á–∏—Å–ª—è–µ—Ç –∫–æ—Å–∏–Ω—É—Å–Ω–æ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ –º–µ–∂–¥—É –≤–µ–∫—Ç–æ—Ä–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤—Å–µ–º–∏ –≤–µ–∫—Ç–æ—Ä–∞–º–∏-–∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º–∏.

–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ ‚Äú–í–æ—Ä–æ—Ç –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è‚Äù:
	1.	–ù–∞—Ö–æ–¥–∏—Ç –ª–∏–¥–µ—Ä–∞ (–∏–Ω—Ç–µ–Ω—Ç —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º score).
	2.	–ü—Ä–æ–≤–µ—Ä–∫–∞ 1 (–ü–æ—Ä–æ–≥): score > config.thresholds.confidence
	3.	–ü—Ä–æ–≤–µ—Ä–∫–∞ 2 (–û—Ç—Ä—ã–≤): score - score_–≤—Ç–æ—Ä–æ–≥–æ_–º–µ—Å—Ç–∞ > config.thresholds.gap
	4.	–ü—Ä–æ–≤–µ—Ä–∫–∞ 3 (–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å): (–ò–ó–ú–ï–ù–ï–ù–ê –õ–û–ì–ò–ö–ê) –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Ç–µ–∫—É—â–µ–≥–æ –ª–∏–¥–µ—Ä–∞ —Å –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–º –∞—Ä–≥—É–º–µ–Ω—Ç–æ–º previous_leader. –û–Ω–∏ –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å.

–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π (Entity Extraction):
	‚Ä¢	–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏: –í—ã–∑—ã–≤–∞–µ—Ç self.repo.get_intent_metadata(–ø–æ–±–µ–¥–∏–≤—à–∏–π_–∏–Ω—Ç–µ–Ω—Ç) –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –±–ª–æ–∫–∞ entity.
	‚Ä¢	–ï—Å–ª–∏ entity –±–ª–æ–∫ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:
	‚Ä¢	–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏–º—è –ø–∞—Ä—Å–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, parser: "simple_numeric").
	‚Ä¢	–í—ã–∑—ã–≤–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –ø–∞—Ä—Å–µ—Ä: extractor = self.extractors["simple_numeric"].
	‚Ä¢	–í—ã–ø–æ–ª–Ω—è–µ—Ç –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ: extracted_data = extractor.extract(text).
	‚Ä¢	–ï—Å–ª–∏ entity –±–ª–æ–∫ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç: –®–∞–≥ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è.

–í—ã—Ö–æ–¥:
	‚Ä¢	–ï—Å–ª–∏ –≤—Å–µ –≤–æ—Ä–æ—Ç–∞ –ø—Ä–æ–π–¥–µ–Ω—ã –ò (—Å—É—â–Ω–æ—Å—Ç—å –Ω–µ —Ç—Ä–µ–±–æ–≤–∞–ª–∞—Å—å –ò–õ–ò —Å—É—â–Ω–æ—Å—Ç—å –±—ã–ª–∞ —É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω–∞):
‚Üí –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç IntentResult(intent_id, score, entities, current_leader).
–í–∞–∂–Ω–æ: —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ–ø–µ—Ä—å —Å–æ–¥–µ—Ä–∂–∏—Ç current_leader, —á—Ç–æ–±—ã Orchestrator –º–æ–≥ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –µ–≥–æ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤—ã–∑–æ–≤–∞.
	‚Ä¢	–ï—Å–ª–∏ –∏–Ω—Ç–µ–Ω—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω, –Ω–æ –∏–∑–≤–ª–µ—á—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—É—é —Å—É—â–Ω–æ—Å—Ç—å –Ω–µ —É–¥–∞–ª–æ—Å—å:
‚Üí –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç None.
	‚Ä¢	–í –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ (–Ω–µ –ø—Ä–æ–π–¥–µ–Ω—ã –≤–æ—Ä–æ—Ç–∞):
‚Üí –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç None.


‚∏ª

### üì¶ –ë—ã—Å—Ç—Ä—ã–π –∫–æ–Ω–≤–µ–π–µ—Ä —Å–ø—Ä–∏–Ω—Ç–∞

#### 0) –£–∫–∞–∂–∏ –ø—É—Ç—å –¥–ª—è .env –∏ –ø–æ–¥–Ω–∏–º–∏ deps
python -m pip install -U numpy onnxruntime transformers tokenizers optimum huggingface_hub python-dotenv

#### 1) –°–∫–∞—á–∞–π/–ø–æ–¥–ª–æ–∂–∏ –º–æ–¥–µ–ª—å (–û–ùNX) –∏ –ø—Ä–æ–ø–∏—à–∏ –ø—É—Ç—å –≤ .env
python scripts/download_model.py --repo-id intfloat/e5-small-v2-onnx --target models/our_model
–∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ:
python scripts/download_model.py --from-dir /path/to/my_export --target models/our_model

#### 2) –ü–æ–¥–≥–æ—Ç–æ–≤—å –±—ç–∫–∞–ø —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ (intents_backup.pkl)
python scripts/prepare_embeddings.py \
  --intents configs/intents.json \
  --dialogue configs/dialogue_map.json \
  --output configs/intents_backup.pkl \
  --device cpu

#### 3) –ú–∏–Ω–∏-–±–µ–Ω—á (–ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ embed/–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏)
python scripts/benchmark_embed.py \
  --backup configs/intents_backup.pkl \
  --text "–ø—É—Å—Ç—å –±—É–¥–µ—Ç 500000" \
  --expected provide_number,confirm_yes,confirm_no \
  --repeat 20

#### 4) –†—É—á–Ω–æ–π e2e —Ç–µ—Å—Ç (—Ä–µ–∞–ª—å–Ω—ã–µ –∫–µ–π—Å—ã)
python intent_classifier/test/manual_test_intents.py \
  --backup configs/intents_backup.pkl \
  --intents configs/intents.json \
  --device cpu \
  --repeat 10
‚∏ª

### üß© –ó–∞–º–µ—á–∞–Ω–∏—è –ø–æ —Ä–∏—Å–∫–∞–º –∏ –Ω—é–∞–Ω—Å–∞–º
	‚Ä¢	–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –º–æ–¥–µ–ª–∏: –Ω—É–∂–µ–Ω ONNX-—ç–∫—Å–ø–æ—Ä—Ç —Ñ–∏—á–µ—Ä-—ç–∫—Å—Ç—Ä–∞–∫—Ç–æ—Ä–∞ (sentence-embeddings). –ï—Å–ª–∏ —Å–∫–∞—á–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –Ω–µ –æ–Ω–Ω—Ö ‚Äî –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–π –∑–∞—Ä–∞–Ω–µ–µ (–≤–Ω–µ —Å–ø—Ä–∏–Ω—Ç–∞) –∏–ª–∏ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π model_wrapper –ø–æ–¥ PyTorch (—Ö—É–∂–µ –ø–æ –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏).
	‚Ä¢	–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤–µ–∫—Ç–æ—Ä–æ–≤: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ L2-–Ω–æ—Ä–º–∞ ‚Üí –∫–æ—Å–∏–Ω—É—Å=dot, –¥–µ—à—ë–≤—ã–π —Å–∫–æ—Ä–∏–Ω–≥.
	‚Ä¢	–ü–æ—Ä–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: –Ω–∞—á–∞–ª—å–Ω—ã–µ confidence=0.4, gap=0.05 ‚Äî —Ä–µ–≥—É–ª–∏—Ä—É—é—Ç—Å—è –ø–æ–¥ –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞.
	‚Ä¢	–°—Ç–∞—Ç–∏—á–Ω–æ—Å—Ç—å: –Ω–∏–∫–∞–∫–æ–π per-call —Å—Ç–∞—Ç–∏–∫–∏ –≤–Ω—É—Ç—Ä–∏ IntentClassifier; –≤—Å—ë —Å–æ—Å—Ç–æ—è–Ω–∏–µ ‚Äî —Å–Ω–∞—Ä—É–∂–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, previous_leader —Ö—Ä–∞–Ω–∏—Ç Orchestrator).
	‚Ä¢	–õ–æ–≥–∏: –≤—Å–µ —Å–∫—Ä–∏–ø—Ç—ã –∏ —è–¥—Ä–æ –ø–µ—á–∞—Ç–∞—é—Ç —Å—Ç—Ä–æ–≥–æ JSON-—Å–æ–±—ã—Ç–∏—è ‚Äî —É–¥–æ–±–Ω–æ —Å—Ç—ã–∫–æ–≤–∞—Ç—å —Å Kibana/Grafana.